# BAZEL-GO

Notes on set up for go project with bazel.

See also [rules_go](https://github.com/bazelbuild/rules_go).

## Set up for go project

1. Initialization of go module
   Initializing creates `go.mod` with the specified module name.

   ```
   go mod init github.com/[user_name]/[project_name]
   ```

2. Creating `uuid/uuid.go`

   Create a file at `/uuid` named `uuid.go`, and add the snippet below.

   ```
   package uuid

   import (
       "github.com/google/uuid"
   )

   func Generate() (string, error) {
       u, err := uuid.NewUUID()
       if err != nil {
           return "", err
       }
       return u.String(), nil
   }

   ```

3. Creating `cmd/main.go`

   Create a file at `/cmd` named `main.go`, and add the snippet below.

   ```
    package main

    import (
        "log"
        "github.com/[user_name]/[project_name]/uuid"
    )

    func main() {
        id, err := uuid.Generate()
        if err != nil {
            log.Fatal(err)
        }
        log.Println(id)
    }
   ```

4. Run `main.go`

   ```
   $ go run cmd/main.go
    2023/11/10 13:44:16 cd9c485a-7f83-11ee-a596-8ef7cbb3e0c5
   ```

## Set up for bazel

1. Creating `WORKSPACE`

   Create a file at the top of your repository named `WORKSPACE`, and add the snippet below.

   ```
   load("@bazel_tools//tools/build_defs/repo:http.bzl", "http_archive")

   http_archive(
       name = "io_bazel_rules_go",
       sha256 = "91585017debb61982f7054c9688857a2ad1fd823fc3f9cb05048b0025c47d023",
       urls = [
           "https://mirror.bazel.build/github.com/bazelbuild/rules_go/releases/download/v0.42.0/rules_go-v0.42.0.zip",
           "https://github.com/bazelbuild/rules_go/releases/download/v0.42.0/rules_go-v0.42.0.zip",
       ],
   )

   http_archive(
       name = "bazel_gazelle",
       sha256 = "b7387f72efb59f876e4daae42f1d3912d0d45563eac7cb23d1de0b094ab588cf",
       urls = [
           "https://mirror.bazel.build/github.com/bazelbuild/bazel-gazelle/releases/download/v0.34.0/bazel-gazelle-v0.34.0.tar.gz",
           "https://github.com/bazelbuild/bazel-gazelle/releases/download/v0.34.0/bazel-gazelle-v0.34.0.tar.gz",
       ],
   )

   load("@io_bazel_rules_go//go:deps.bzl", "go_register_toolchains", "go_rules_dependencies")
   load("@bazel_gazelle//:deps.bzl", "gazelle_dependencies", "go_repository")

   ############################################################
   # Define your own dependencies here using go_repository.
   # Else, dependencies declared by rules_go/gazelle will be used.
   # The first declaration of an external repository "wins".
   ############################################################

   go_repository(
       name = "com_github_google_uuid",
       importpath = "github.com/google/uuid",
       sum = "h1:MtMxsa51/r9yyhkyLsVeVt0B+BGQZzpQiTQ4eHZ8bc4=",
       version = "v1.4.0",
   )

   go_rules_dependencies()

   go_register_toolchains(version = "1.20.5")

   gazelle_dependencies()

   ```

2. Creating `BUILD`

   Create a file at the top of your repository named `BUILD`, and add the snippet below.

   ```
   load("@bazel_gazelle//:def.bzl", "gazelle")

   # gazelle:prefix github.com/[user_name]/[project_name]
   gazelle(name = "gazelle")

   ```

3. Generate a BUILD.bazel in each directory using gazelle

   Normally, a BUILD file must be created for each directory, but with gazelle, it can be generated automatically.

   ```
   $ bazel run //:gazelle
   ```

4. Update `WORKSPACE`

   Information on dependent libraries needs to be added to the `WORKSPACE`. This is also automatically generated by gazelle.

   ```
   $ bazel run //:gazelle -- update-repos -from_file=go.mod
   ```

5. Run `main.go` with bazel

   ```
   $ bazel run //cmd:main
    INFO: Analyzed target //cmd:main (1 packages loaded, 294 targets configured).
    INFO: Found 1 target...
    Target //cmd:main up-to-date:
    bazel-bin/cmd/main_/main
    INFO: Elapsed time: 57.401s, Critical Path: 54.56s
    INFO: 6 processes: 1 internal, 5 darwin-sandbox.
    INFO: Build completed successfully, 6 total actions
    INFO: Running command line: bazel-bin/cmd/main_/main
    2023/11/10 13:38:55 0e368dcc-7f83-11ee-913c-8ef7cbb3e0c5
   ```
